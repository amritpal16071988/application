#!groovy
pipeline {
agent {
  label 'ansible'
}
  parameters {
    string (name: 'app_version', description: 'Please enter the app_version')
  }  
  stages {  
    stage('Scanning_code') {
        when {
          anyOf{
            branch 'dev';
            allOf{
               branch 'qa' 
               expression { app_version ==~ /G.R.C./ }
            }
          }
          beforeOptions true
        }      
      steps {
        sh ''' 
          echo "Run Sonar Scan"
        '''
      }
    }
      stage('Build') {
        when {
          anyOf{
            branch 'dev';
            allOf{
               branch 'qa' 
               expression { app_version ==~ /G.R.C./ }
            }
          }
          beforeOptions true
        }
      steps {
        sh ''' 
          echo "building application"
        '''
      }
    }  
    stage('dev_Software_deployment') {
      when {
        branch 'dev'
        beforeOptions true
      }      
      steps {
        sh ''' 
          ansible --version
        '''
      }
    }
    stage('qa_Software_deployment') {
      when {
        branch 'qa'
        expression { app_version ==~ /G.R.C./ }
        beforeOptions true
      }      
      steps {
        sh ''' 
          ansible --version
        '''
      }
    } 
    stage('uat_Software_deployment') {
      when {
        branch 'uat'
        expression { app_version ==~ /G.R.C./ }
        beforeOptions true
      }      
      steps {
        sh ''' 
          ansible --version
        '''
      }
    }
    stage('prod_Software_deployment') {
      when {
        branch 'prod'
        expression { app_version ==~ /G.R.C./ }
        beforeOptions true
      }      
      steps {
        sh ''' 
          ansible --version
        '''
      }
    }
    stage('Sanity_check') {   
      steps {
        sh '''
        env
        if [ $BRANCH_NAME = 'dev' ]
        then
          echo "Checking the dev application health"
        elif [ $BRANCH_NAME = 'qa' ]
        then
          echo "Checking the qa application health"
        elif [ $BRANCH_NAME = 'uat' ]
        then
          echo "Checking the uat application health"
        elif [ $BRANCH_NAME = 'prod' ] 
        then
          echo "Checking the prod application health"
        fi
        '''
      }
    }  
  } 
  post {
    always {
      cleanWs()
    }
  }
}
